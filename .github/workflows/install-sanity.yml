name: Installation Sanity

on:
  schedule:
    # Daily at 06:00 UTC
    - cron: "0 6 * * *"
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  cargo-install:
    name: cargo install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: dtolnay/rust-toolchain@stable

      - name: Install from crates.io
        run: cargo install vortix

      - name: Get expected version from crates.io
        id: expected
        run: |
          VERSION=$(curl -s -H "User-Agent: vortix-ci (https://github.com/Harry-kp/vortix)" https://crates.io/api/v1/crates/vortix | python3 -c "import sys,json; print(json.load(sys.stdin)['crate']['max_version'])")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify --version
        run: |
          OUTPUT=$(vortix --version)
          echo "Got: $OUTPUT"
          echo "$OUTPUT" | grep -q "${{ steps.expected.outputs.version }}"

      - name: Verify --help
        run: vortix --help

      - name: "Verify sudo access (Linux: expect failure before symlink)"
        if: runner.os == 'Linux'
        run: |
          if sudo vortix --version 2>/dev/null; then
            echo "ERROR: sudo vortix should NOT work without symlink on Linux"
            exit 1
          fi
          echo "Confirmed: sudo vortix fails without symlink (expected)"

      - name: "Verify sudo access (Linux: create symlink and retry)"
        if: runner.os == 'Linux'
        run: |
          sudo ln -s "$HOME/.cargo/bin/vortix" /usr/local/bin/vortix
          OUTPUT=$(sudo vortix --version)
          echo "After symlink: $OUTPUT"

      - name: Verify sudo access (macOS)
        if: runner.os == 'macOS'
        run: |
          OUTPUT=$(sudo vortix --version)
          echo "sudo vortix works on macOS: $OUTPUT"

  shell-installer:
    name: Shell installer (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Run shell installer
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/Harry-kp/vortix/releases/latest/download/vortix-installer.sh | sh

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Get expected version from latest release
        id: expected
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(gh release view --repo Harry-kp/vortix --json tagName -q '.tagName' | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify --version
        run: |
          OUTPUT=$(vortix --version)
          echo "Got: $OUTPUT"
          echo "$OUTPUT" | grep -q "${{ steps.expected.outputs.version }}"

      - name: Verify --help (shell-installer)
        run: vortix --help

      - name: "Verify sudo access (Linux: expect failure before symlink)"
        if: runner.os == 'Linux'
        run: |
          if sudo vortix --version 2>/dev/null; then
            echo "ERROR: sudo vortix should NOT work without symlink on Linux"
            exit 1
          fi
          echo "Confirmed: sudo vortix fails without symlink (expected)"

      - name: "Verify sudo access (Linux: create symlink and retry)"
        if: runner.os == 'Linux'
        run: |
          sudo ln -s "$HOME/.cargo/bin/vortix" /usr/local/bin/vortix
          OUTPUT=$(sudo vortix --version)
          echo "After symlink: $OUTPUT"

      - name: Verify sudo access (macOS)
        if: runner.os == 'macOS'
        run: |
          OUTPUT=$(sudo vortix --version)
          echo "sudo vortix works on macOS: $OUTPUT"

  static-binary:
    name: Static binary (Linux musl)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release tag
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(gh release view --repo Harry-kp/vortix --json tagName -q '.tagName')
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download and extract musl binary
        run: |
          curl -LO "https://github.com/Harry-kp/vortix/releases/download/${{ steps.release.outputs.tag }}/vortix-x86_64-unknown-linux-musl.tar.xz"
          tar -xf vortix-x86_64-unknown-linux-musl.tar.xz
          chmod +x vortix-x86_64-unknown-linux-musl/vortix

      - name: Verify --version
        run: |
          OUTPUT=$(./vortix-x86_64-unknown-linux-musl/vortix --version)
          echo "Got: $OUTPUT"
          echo "$OUTPUT" | grep -q "${{ steps.release.outputs.version }}"

      - name: Verify --help
        run: ./vortix-x86_64-unknown-linux-musl/vortix --help

      - name: Verify sudo access (copy to /usr/local/bin)
        run: |
          sudo cp vortix-x86_64-unknown-linux-musl/vortix /usr/local/bin/vortix
          OUTPUT=$(sudo vortix --version)
          echo "sudo vortix works: $OUTPUT"

  arch-linux:
    name: Arch Linux (pacman)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install vortix from extra repo
        run: |
          pacman -Syu --noconfirm vortix

      - name: Verify --version
        run: |
          OUTPUT=$(vortix --version)
          echo "Got: $OUTPUT"
          # Log version but don't assert -- Arch package may lag behind
          echo "Arch package version: $OUTPUT"

      - name: Verify --help
        run: vortix --help

      - name: Verify binary is in system PATH
        run: |
          LOCATION=$(command -v vortix)
          echo "Installed at: $LOCATION"
          # pacman may install to /usr/bin or /usr/sbin
          echo "$LOCATION" | grep -qE "^/usr/(s?bin)/vortix$"

  homebrew:
    name: Homebrew (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Homebrew (Linux)
        if: runner.os == 'Linux'
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"

      - name: Install vortix from tap
        run: brew install Harry-kp/tap/vortix

      - name: Get expected version from latest release
        id: expected
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(gh release view --repo Harry-kp/vortix --json tagName -q '.tagName' | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify --version
        run: |
          OUTPUT=$(vortix --version)
          echo "Got: $OUTPUT"
          echo "$OUTPUT" | grep -q "${{ steps.expected.outputs.version }}"

      - name: Verify --help
        run: vortix --help

      - name: Verify binary is in Homebrew PATH
        run: |
          LOCATION=$(command -v vortix)
          echo "Installed at: $LOCATION"

  npm-install:
    name: npm install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install vortix from npm
        run: npm install -g @harry-kp/vortix

      - name: Get expected version from latest release
        id: expected
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(gh release view --repo Harry-kp/vortix --json tagName -q '.tagName' | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify --version
        run: |
          OUTPUT=$(vortix --version)
          echo "Got: $OUTPUT"
          echo "$OUTPUT" | grep -q "${{ steps.expected.outputs.version }}"

      - name: Verify --help
        run: vortix --help
